local replicated_storage = game:GetService("ReplicatedStorage")
local camera = workspace.CurrentCamera

local modules = {}
for _, module in replicated_storage.module:GetDescendants() do
    if string.find(module.ClassName, "Script") then
        modules[module.Name] = module
    end
end

local caster = require(modules.caster)

local function getClosestPlayer()
    local closestDistance = 300
    local closestHead = nil
    
    local center = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    
    for _, character in workspace.characters:GetChildren() do
        if character.Name == "StarterCharacter" then
            continue
        end
        
        local head = character:FindFirstChild("head")
        if not head then
            continue
        end
        
        local position, onScreen = camera:WorldToViewportPoint(head.Position)
        if not onScreen then
            continue
        end
        
        local screenPos = Vector2.new(position.X, position.Y)
        local distance = (center - screenPos).Magnitude
        
        if distance < closestDistance then
            closestDistance = distance
            closestHead = head
        end
    end
    
    return closestHead
end

local old_fire = caster.fire
local lastClosestHead = nil

caster.fire = newcclosure(function(_, origin_pos, direction, data, ...)
    if lastClosestHead then
        local headSize = lastClosestHead.Size.Y
        local targetPos = lastClosestHead.Position - Vector3.new(0, headSize * 0.3, 0)
        
        local newDirection = (targetPos - origin_pos).Unit
        return old_fire(_, origin_pos, newDirection, data, ...)
    end
    
    return old_fire(_, origin_pos, direction, data, ...)
end)

game:GetService("RunService").RenderStepped:Connect(function()
    lastClosestHead = getClosestPlayer()
end)
